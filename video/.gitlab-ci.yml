py_style:
  stage: test
  script:
    - cd server
    - python -m venv env
    - source env/bin/activate
    - pip install -U pip wheel setuptools
    - XDG_CACHE_HOME=/cache pip install black flake8 isort
    - black --check venueless tests
    - flake8 venueless tests
    - isort -rc -c venueless tests
  interruptible: true
  tags:
    - python3
py_test:
  stage: test
  services:
    - redis:latest
    - postgres:11
  script:
    - cd server
    - python -m venv env
    - source env/bin/activate
    - pip install -U pip wheel setuptools
    - XDG_CACHE_HOME=/cache pip install -Ur requirements.txt
    - VENUELESS_REDIS_HOST=redis VENUELESS_DB_TYPE=postgresql VENUELESS_DB_NAME=venueless VENUELESS_DB_USER=venueless VENUELESS_DB_PASS=venueless VENUELESS_DB_HOST=postgres py.test tests/ --reuse-db
  interruptible: true
  tags:
    - python3

variables:
  POSTGRES_DB: stayseeated
  POSTGRES_USER: venueless
  POSTGRES_PASSWORD: venueless
  POSTGRES_HOST_AUTH_METHOD: trust

