<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <link rel="icon" href="./public/favicon.ico" />
    <title>eventyay</title>
  </head>
  <body>
    <div id="app"></div>
    <div id="browser-block" style="display: none;">
      <h1>Sorry.</h1>
      <h2>Your browser does not support some of the features we need.</h2>
      <h2>Why don't you try an up-to-date version of one of the following browsers?</h2>
      <div id="compatible-browsers">
        <a href="https://www.google.com/chrome/" class="chrome"><span></span>Google Chrome</a>
        <a href="https://mozilla.org/firefox" class="firefox"><span></span>Mozilla Firefox</a>
      </div>
    </div>
  <script type="module" src="./src/preloader.js"></script>

  <!-- Debugging helpers: used to diagnose module/network load failures. Edit only for debugging. -->
  <style>
    #debug-panel{position:fixed;right:12px;top:12px;z-index:9999;max-width:460px;background:rgba(0,0,0,0.85);color:#e6e6e6;font-family:monospace;font-size:12px;padding:10px;border-radius:6px}
    #debug-panel h4{margin:0 0 6px 0;font-size:13px}
    #debug-log{max-height:320px;overflow:auto;background:rgba(255,255,255,0.02);padding:8px;border-radius:4px}
    #debug-panel button{margin-top:8px;margin-right:6px}
    .dbg-ok{color:#7fffd4}
    .dbg-err{color:#ff7b7b}
  </style>
  <div id="debug-panel" aria-live="polite">
    <h4>Startup resource debug</h4>
    <div id="debug-log">Initializing...</div>
    <div>
      <button id="dbg-fetch">Fetch resources</button>
      <button id="dbg-import">Import modules (may execute code)</button>
  <button id="dbg-last">Fetch last failing asset</button>
  <button id="dbg-sourcemap">Fetch last asset source-map</button>
      <button id="dbg-clear">Clear</button>
    </div>
  </div>

  <script type="module">
    // Paths to check on startup. Update if your build outputs different locations.
    // Includes both source modules (dev) and the built bundles found in dist (preview/production).
    const MODULE_PATHS = [
      './src/preloader.js',
      './src/main.js',
      './src/router/index.js',
      './src/store/index.js',
      './src/theme.js',
      './src/i18n.js',
      './src/features.js',
      './src/posters.js',
      // Built bundles (dist/assets) â€” helpful when running the built site under /video
      '/video/assets/main-CjQARqvN.js',
      '/video/assets/main-D4u9AzzX.js',
      '/video/assets/main-DP7bCj9u.js'
    ];

    const logEl = document.getElementById('debug-log');
    function log(msg, cls){
      const el = document.createElement('div');
      el.textContent = `[${new Date().toISOString()}] ${msg}`;
      if(cls) el.className = cls;
      logEl.appendChild(el);
      logEl.scrollTop = logEl.scrollHeight;
      if(cls === 'dbg-err') console.error(msg); else console.info(msg);
    }

    window.addEventListener('error', ev => {
      const src = ev.filename || (ev.target && ev.target.src) || 'unknown';
      log(`Window error: ${ev.message || ev.type} @ ${src}`, 'dbg-err');
    }, true);

    window.addEventListener('unhandledrejection', ev => {
      const reason = ev.reason && ev.reason.message ? ev.reason.message : String(ev.reason);
      log(`UnhandledRejection: ${reason}`, 'dbg-err');
      // Try to extract a URL from the rejection message when dynamic import fails
      const text = reason && typeof reason === 'string' ? reason : (ev.reason && ev.reason.stack) ? ev.reason.stack : '';
      const m = text && text.match(/https?:\/\/[\w\.\-:\/]+\/[^\s'"\)]+\.js/);
      if(m){
        lastFailingAsset = m[0];
        log(`Captured failing asset URL: ${lastFailingAsset}`, 'dbg-err');
      }
    });

    function watchScriptTags(){
      const scripts = Array.from(document.getElementsByTagName('script'));
      scripts.forEach(s => {
        if(!s.src) return;
        if(s.__dbgBound) return;
        s.__dbgBound = true;
        s.addEventListener('load', () => log(`Script loaded: ${s.src}`, 'dbg-ok'));
        s.addEventListener('error', () => log(`Script ERROR loading: ${s.src}`, 'dbg-err'));
      });
    }
    watchScriptTags();

    async function fetchResources(){
      log('Starting fetch checks...');
      for(const p of MODULE_PATHS){
        try{
          const url = new URL(p, location.href).toString();
          const res = await fetch(url, {cache: 'no-store'});
          if(res.ok){
            const ct = res.headers.get('content-type') || '';
            const cl = res.headers.get('content-length') || 'unknown';
            log(`FETCH OK  ${url}  status=${res.status} content-type=${ct} content-length=${cl}`, 'dbg-ok');
          } else {
            log(`FETCH FAIL ${url}  status=${res.status} ${res.statusText}`, 'dbg-err');
            lastFailingAsset = url;
            log(`Captured lastFailingAsset = ${lastFailingAsset}`, 'dbg-err');
          }
        }catch(err){
          log(`FETCH ERROR ${p} -> ${err.message || err}`, 'dbg-err');
          // network-level error: capture the attempted URL
          try{ lastFailingAsset = new URL(p, location.href).toString(); log(`Captured lastFailingAsset = ${lastFailingAsset}`, 'dbg-err'); }catch(e){}
        }
      }
    }

    // Track last failing asset URL for targeted checks
    let lastFailingAsset = null;

    // Attempt to fetch an arbitrary asset URL and report status and first 2KB of body (text)
    async function fetchAsset(url){
      if(!url) { log('No URL provided', 'dbg-err'); return; }
      log(`Fetching asset: ${url}`);
      try{
        const res = await fetch(url, {cache: 'no-store'});
        log(`Asset fetch status: ${res.status} ${res.statusText}` + (res.ok ? ' (OK)' : ''), res.ok ? 'dbg-ok' : 'dbg-err');
        const ct = res.headers.get('content-type') || '';
        log(`Content-Type: ${ct}`);
        if(res.ok && ct.indexOf('application/javascript') !== -1){
          const text = await res.text();
          log('--- asset body (first 2KB) ---');
          log(text.slice(0, 2048));
        } else if(!res.ok) {
          const txt = await res.text().catch(()=>null);
          if(txt) log(`Body snippet: ${txt.slice(0,1024)}`, 'dbg-err');
        }
      }catch(err){
        log(`Asset FETCH ERROR ${url} -> ${err.message || err}`, 'dbg-err');
      }
    }

    async function fetchSourcemapFor(url){
      if(!url) { log('No URL provided for source-map fetch', 'dbg-err'); return; }
      // Try common source-map resolution: append .map or look for //# sourceMappingURL in file
      try{
        log(`Attempting to fetch source-map for ${url}`);
        const res = await fetch(url, {cache: 'no-store'});
        if(!res.ok){ log(`Unable to fetch asset to inspect sourcemap header: ${res.status}`, 'dbg-err'); return; }
        const body = await res.text();
        const m = body.match(/[#@]\s*sourceMappingURL=([^\s'"\n]+)/);
        let mapUrl;
        if(m && m[1]){
          mapUrl = new URL(m[1], url).toString();
        } else {
          mapUrl = url + '.map';
        }
        log(`Resolved source-map URL: ${mapUrl}`);
        const resMap = await fetch(mapUrl, {cache: 'no-store'});
        if(resMap.ok){
          const mapBody = await resMap.text();
          log('--- sourcemap head ---');
          log(mapBody.slice(0, 2048));
        } else {
          log(`Source-map fetch failed: ${resMap.status} ${resMap.statusText}`, 'dbg-err');
        }
      }catch(err){
        log(`Source-map fetch error: ${err.message || err}`, 'dbg-err');
      }
    }

    async function importResources(){
      log('Starting dynamic imports (will execute module code):');
      for(const p of MODULE_PATHS){
        try{
          await import(p + '?_dbg=' + Date.now());
          log(`IMPORT OK  ${p}`, 'dbg-ok');
        }catch(err){
          log(`IMPORT FAIL ${p} -> ${err && err.stack ? err.stack : err}`, 'dbg-err');
        }
      }
    }

    document.getElementById('dbg-fetch').addEventListener('click', fetchResources);
    document.getElementById('dbg-import').addEventListener('click', () => {
      if(!confirm('Dynamic import will execute module code (may initialize the app). Proceed?')) return;
      importResources().catch(err => {
        log(`ImportResources top-level catch: ${err && err.stack ? err.stack : err}`, 'dbg-err');
        // If the error message contains a URL, capture it
        const text = err && err.stack ? err.stack : String(err);
        const m = text.match(/https?:\/\/[\w\.\-:\/]+\/[^\s'"\)]+\.js/);
        if(m){ lastFailingAsset = m[0]; log(`Captured failing asset URL: ${lastFailingAsset}`, 'dbg-err'); }
      });
    });
    document.getElementById('dbg-clear').addEventListener('click', () => logEl.innerHTML = '');
    document.getElementById('dbg-last').addEventListener('click', () => fetchAsset(lastFailingAsset));
    document.getElementById('dbg-sourcemap').addEventListener('click', () => fetchSourcemapFor(lastFailingAsset));

    window.addEventListener('DOMContentLoaded', () => setTimeout(fetchResources, 120));
  </script>
  </body>
  </html>
