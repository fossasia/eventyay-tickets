{% extends "pretixpresale/event/checkout_base.html" %}
{% load i18n %}
{% load bootstrap3 %}
{% load rich_text %}
{% load l10n %}
{% load money %}
{% load thumb %}
{% block inner %}
    <p>
        {% trans "For some of the products in your cart, you can choose additional options before you continue." %}
    </p>
    <form class="form-horizontal" method="post" data-asynctask
            data-asynctask-headline="{% trans "We're now trying to book these add-ons for you!" %}">
        {% csrf_token %}
        <div class="panel-group addons" id="questions_group">
            {% for form in forms %}
                <details class="panel panel-default" open>
                    <summary class="panel-heading">
                        <h4 class="panel-title">
                            <strong>{{ form.product.name }}{% if form.variation %}
                                – {{ form.variation }}
                            {% endif %}</strong>
                            <i class="fa fa-angle-down collapse-indicator" aria-hidden="true"></i>
                        </h4>
                    </summary>
                    <div id="cp{{ form.cartpos.pk }}">
                        <div class="panel-body">
                            {% if form.cartpos.subevent %}
                                <p>
                                    <span class="fa fa-calendar" aria-hidden="true"></span>
                                    {{ form.cartpos.subevent.name }} &middot; {{ form.cartpos.subevent.get_date_range_display }}
                                    {% if form.cartpos.event.settings.show_times %}
                                        <span class="fa fa-clock-o" aria-hidden="true"></span>
                                        {{ form.cartpos.subevent.date_from|date:"TIME_FORMAT" }}
                                    {% endif %}
                                </p>
                            {% endif %}
                            {% for c in form.categories %}
                                <fieldset>
                                    <legend>{{ c.category.name }}</legend>
                                    {% if c.category.description %}
                                        {{ c.category.description|rich_text }}
                                    {% endif %}
                                    <p>
                                        {% if c.min_count == c.max_count %}
                                            {% blocktrans trimmed count min_count=c.min_count %}
                                                You need to choose exactly one option from this category.
                                            {% plural %}
                                                You need to choose {{ min_count }} options from this category.
                                            {% endblocktrans %}
                                        {% elif c.min_count == 0 and c.max_count >= c.products|length and not c.multi_allowed %}
                                        {% elif c.min_count == 0 %}
                                            {% blocktrans trimmed with max_count=c.max_count %}
                                                You can choose up to {{ max_count }} options from this category.
                                            {% endblocktrans %}
                                        {% else %}
                                            {% blocktrans trimmed with min_count=c.min_count max_count=c.max_count %}
                                                You can choose between {{ min_count }} and {{ max_count }} options from
                                                this category.
                                            {% endblocktrans %}
                                        {% endif %}
                                    </p>
                                    {% for product in c.products %}
                                        {% if product.has_variations %}
                                            <details class="product-with-variations" {% if event.settings.show_variations_expanded or product.expand %}open{% endif %}>
                                                <summary class="row-fluid product-row headline">
                                                    <div class="col-md-8 col-xs-12">
                                                        {% if product.picture %}
                                                            <a href="{{ product.picture.url }}" class="productpicture"
                                                               data-title="{{ product.name|force_escape|force_escape }}"
                                                                    {# Yes, double-escape to prevent XSS in lightbox #}
                                                               data-lightbox="{{ product.id }}">
                                                                <img src="{{ product.picture|thumb:'60x60^' }}"
                                                                     alt="{{ product.name }}"/>
                                                            </a>
                                                        {% endif %}
                                                        <div class="product-description {% if product.picture %}with-picture{% endif %}">
                                                            <h4>
                                                                <a href="#" data-toggle="variations">
                                                                    {{ product.name }}
                                                                </a>
                                                            </h4>
                                                            {% if product.description %}
                                                                <div class="product-description">
                                                                    {{ product.description|localize|rich_text }}
                                                                </div>
                                                            {% endif %}
                                                            {% if product.min_per_order and product.min_per_order > 1 %}
                                                                <p>
                                                                    <small>
                                                                        {% blocktrans trimmed with num=product.min_per_order %}
                                                                            minimum amount to order: {{ num }}
                                                                        {% endblocktrans %}
                                                                    </small>
                                                                </p>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    <div class="col-md-2 col-xs-6 price">
                                                        {% if c.price_included %}
                                                        {% elif product.free_price %}
                                                            {% blocktrans trimmed with price=product.min_price|money:event.currency %}
                                                                from {{ price }}
                                                            {% endblocktrans %}
                                                        {% elif product.min_price != product.max_price %}
                                                            {{ product.min_price|money:event.currency  }} – {{ product.max_price|money:event.currency  }}
                                                        {% elif not product.min_price and not product.max_price %}
                                                        {% else %}
                                                            {{ product.min_price|money:event.currency }}
                                                        {% endif %}
                                                    </div>
                                                    <div class="col-md-2 col-xs-6 availability-box">
                                                        {% if not event.settings.show_variations_expanded %}
                                                            <a href="#" data-toggle="variations" class="js-only">
                                                                {% trans "Show variants" %}
                                                            </a>
                                                        {% endif %}
                                                    </div>
                                                    <div class="clearfix"></div>
                                                </summary>
                                                <div class="variations {% if not event.settings.show_variations_expanded %}variations-collapsed{% endif %}">
                                                    {% for var in product.available_variations %}
                                                        <div class="row-fluid product-row variation">
                                                            <div class="col-md-8 col-xs-12">
                                                                <h5>
                                                                    <label for="cp_{{ form.cartpos.pk }}_variation_{{ product.pk }}_{{ var.pk }}">
                                                                        {{ var }}
                                                                    </label>
                                                                </h5>
                                                                {% if var.description %}
                                                                    <div class="variation-description">
                                                                        {{ var.description|localize|rich_text }}
                                                                    </div>
                                                                {% endif %}
                                                                {% if product.do_show_quota_left %}
                                                                    {% include "pretixpresale/event/fragment_quota_left.html" with avail=var.cached_availability %}
                                                                {% endif %}
                                                            </div>
                                                            <div class="col-md-2 col-xs-6 price">
                                                                {% if not c.price_included %}
                                                                    {% if var.original_price %}
                                                                        {% if event.settings.display_net_prices %}
                                                                            <del>{{ var.original_price.net|money:event.currency }}</del>
                                                                        {% else %}
                                                                            <del>{{ var.original_price.gross|money:event.currency }}</del>
                                                                        {% endif %}
                                                                        <ins>
                                                                    {% endif %}
                                                                    {% if product.free_price %}
                                                                        <div class="input-group input-group-price">
                                                                            <span class="input-group-addon">{{ event.currency }}</span>
                                                                            <input type="number" class="form-control input-product-price"
                                                                                    placeholder="0"
                                                                                    min="{% if event.settings.display_net_prices %}{{ var.display_price.net|money_numberfield:event.currency }}{% else %}{{ var.display_price.gross|money_numberfield:event.currency }}{% endif %}"
                                                                                    name="cp_{{ form.cartpos.pk }}_variation_{{ product.id }}_{{ var.id }}_price"
                                                                                    title="{% blocktrans trimmed with product=var.value %}Modify price for {{ product }}{% endblocktrans %}"
                                                                                    step="any"
                                                                                    value="{% if event.settings.display_net_prices %}{{ var.initial_price.net|money_numberfield:event.currency }}{% else %}{{ var.initial_price.gross|money_numberfield:event.currency }}{% endif %}"
                                                                            >
                                                                        </div>
                                                                    {% elif not var.display_price.gross %}
                                                                    {% elif event.settings.display_net_prices %}
                                                                        {{ var.display_price.net|money:event.currency }}
                                                                    {% else %}
                                                                        {{ var.display_price.gross|money:event.currency }}
                                                                    {% endif %}
                                                                    {% if product.original_price or var.original_price %}
                                                                        </ins>
                                                                    {% endif %}
                                                                    {% if product.includes_mixed_tax_rate %}
                                                                        {% if event.settings.display_net_prices %}
                                                                            <small>{% trans "plus taxes" %}</small>
                                                                        {% else %}
                                                                            <small>{% trans "incl. taxes" %}</small>
                                                                        {% endif %}
                                                                    {% elif var.display_price.rate and var.display_price.gross and event.settings.display_net_prices %}
                                                                        <small>{% blocktrans trimmed with rate=var.display_price.rate|floatformat:-2 name=var.display_price.name %}
                                                                            <strong>plus</strong> {{ rate }}% {{ name }}
                                                                        {% endblocktrans %}</small>
                                                                    {% elif var.display_price.rate and var.display_price.gross %}
                                                                        <small>{% blocktrans trimmed with rate=var.display_price.rate|floatformat:-2 name=var.display_price.name %}
                                                                            incl. {{ rate }}% {{ name }}
                                                                        {% endblocktrans %}</small>
                                                                    {% endif %}
                                                                {% endif %}
                                                            </div>
                                                            {% if var.cached_availability.0 == 100 or var.initial %}
                                                                <div class="col-md-2 col-xs-6 availability-box available">
                                                                    {% if c.max_count == 1 or not c.multi_allowed %}
                                                                        <label class="product-checkbox-label">
                                                                            <input type="checkbox" value="1"
                                                                                   {% if var.initial %}checked="checked"{% endif %}
                                                                                   id="cp_{{ form.cartpos.pk }}_variation_{{ product.id }}_{{ var.id }}"
                                                                                   name="cp_{{ form.cartpos.pk }}_variation_{{ product.id }}_{{ var.id }}"
                                                                                   data-exclusive-prefix="cp_{{ form.cartpos.pk }}_variation_{{ product.id }}_"
                                                                                   title="{% blocktrans with product=product.name var=var.name %}Amount of {{ product }} – {{ var }} to order{% endblocktrans %}">
                                                                        </label>
                                                                    {% else %}
                                                                        <input type="number" class="form-control input-product-count" placeholder="0" min="0"
                                                                               {% if var.initial %}value="{{ var.initial }}"{% endif %}
                                                                               max="{{ c.max_count }}"
                                                                               pattern="\d*"
                                                                               id="cp_{{ form.cartpos.pk }}_variation_{{ product.id }}_{{ var.id }}"
                                                                               name="cp_{{ form.cartpos.pk }}_variation_{{ product.id }}_{{ var.id }}">
                                                                    {% endif %}
                                                                </div>
                                                            {% else %}
                                                                {% include "pretixpresale/event/fragment_availability.html" with price=var.display_price.gross avail=var.cached_availability.0 event=event product=product var=var %}
                                                            {% endif %}
                                                            <div class="clearfix"></div>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            </details>
                                        {% else %}
                                            <div class="row-fluid product-row simple">
                                                <div class="col-md-8 col-xs-12">
                                                    {% if product.picture %}
                                                        <a href="{{ product.picture.url }}" class="productpicture"
                                                           data-title="{{ product.name|force_escape|force_escape }}"
                                                                {# Yes, double-escape to prevent XSS in lightbox #}
                                                           data-lightbox="{{ product.id }}">
                                                            <img src="{{ product.picture|thumb:'60x60^' }}"
                                                                 alt="{{ product.name }}"/>
                                                        </a>
                                                    {% endif %}
                                                    <div class="product-description {% if product.picture %}with-picture{% endif %}">
                                                        <h4>
                                                            <label for="cp_{{ form.cartpos.pk }}_product_{{ product.id }}">{{ product.name }}</label>
                                                        </h4>
                                                        {% if product.description %}
                                                            <div class="product-description">
                                                                {{ product.description|localize|rich_text }}
                                                            </div>
                                                        {% endif %}
                                                        {% if product.do_show_quota_left %}
                                                            {% include "pretixpresale/event/fragment_quota_left.html" with avail=product.cached_availability %}
                                                        {% endif %}
                                                        {% if product.min_per_order and product.min_per_order > 1 %}
                                                            <p>
                                                                <small>
                                                                    {% blocktrans trimmed with num=product.min_per_order %}
                                                                        minimum amount to order: {{ num }}
                                                                    {% endblocktrans %}
                                                                </small>
                                                            </p>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="col-md-2 col-xs-6 price">
                                                    {% if not c.price_included %}
                                                        {% if product.original_price %}
                                                            {% if event.settings.display_net_prices %}
                                                                <del>{{ product.original_price.net|money:event.currency }}</del>
                                                            {% else %}
                                                                <del>{{ product.original_price.gross|money:event.currency }}</del>
                                                            {% endif %}
                                                            <ins>
                                                        {% endif %}
                                                        {% if product.free_price %}
                                                            <div class="input-group input-group-price">
                                                                <span class="input-group-addon">{{ event.currency }}</span>
                                                                <input type="number" class="form-control input-product-price" placeholder="0"
                                                                        min="{% if event.settings.display_net_prices %}{{ product.display_price.net|money_numberfield:event.currency }}{% else %}{{ product.display_price.gross|money_numberfield:event.currency }}{% endif %}"
                                                                        name="cp_{{ form.cartpos.pk }}_product_{{ product.id }}_price"
                                                                        title="{% blocktrans trimmed with product=product.name %}Modify price for {{ product }}{% endblocktrans %}"
                                                                        value="{% if event.settings.display_net_prices %}{{ product.initial_price.net|money_numberfield:event.currency }}{% else %}{{ product.initial_price.gross|money_numberfield:event.currency }}{% endif %}"
                                                                        step="any">
                                                            </div>
                                                        {% elif not product.display_price.gross %}
                                                        {% elif event.settings.display_net_prices %}
                                                            {{ product.display_price.net|money:event.currency }}
                                                        {% else %}
                                                            {{ product.display_price.gross|money:event.currency }}
                                                        {% endif %}
                                                        {% if product.original_price %}
                                                            </ins>
                                                        {% endif %}
                                                        {% if product.includes_mixed_tax_rate %}
                                                            {% if event.settings.display_net_prices %}
                                                                <small>{% trans "plus taxes" %}</small>
                                                            {% else %}
                                                                <small>{% trans "incl. taxes" %}</small>
                                                            {% endif %}
                                                        {% elif product.display_price.rate and product.display_price.gross and event.settings.display_net_prices %}
                                                            <small>{% blocktrans trimmed with rate=product.display_price.rate|floatformat:-2 name=product.display_price.name %}
                                                                <strong>plus</strong> {{ rate }}% {{ name }}
                                                            {% endblocktrans %}</small>
                                                        {% elif product.display_price.rate and product.display_price.gross %}
                                                            <small>{% blocktrans trimmed with rate=product.display_price.rate|floatformat:-2 name=product.display_price.name %}
                                                                incl. {{ rate }}% {{ name }}
                                                            {% endblocktrans %}</small>
                                                        {% endif %}
                                                    {% endif %}
                                                </div>
                                                {% if product.cached_availability.0 == 100 or product.initial %}
                                                    <div class="col-md-2 col-xs-6 availability-box available">
                                                        {% if c.max_count == 1 or not c.multi_allowed %}
                                                            <label class="product-checkbox-label">
                                                                <input type="checkbox" value="1"
                                                                       {% if product.initial %}checked="checked"{% endif %}
                                                                       name="cp_{{ form.cartpos.pk }}_product_{{ product.id }}"
                                                                       id="cp_{{ form.cartpos.pk }}_product_{{ product.id }}">
                                                            </label>
                                                        {% else %}
                                                            <input type="number" class="form-control input-product-count" placeholder="0" min="0"
                                                                   pattern="\d*"
                                                                   max="{{ c.max_count }}"
                                                                   {% if product.initial %}value="{{ product.initial }}"{% endif %}
                                                                   name="cp_{{ form.cartpos.pk }}_product_{{ product.id }}"
                                                                   id="cp_{{ form.cartpos.pk }}_product_{{ product.id }}"
                                                                   title="{% blocktrans with product=product.name %}Amount of {{ product }} to order{% endblocktrans %}">
                                                        {% endif %}
                                                    </div>
                                                {% else %}
                                                    {% include "pretixpresale/event/fragment_availability.html" with price=product.display_price.gross avail=product.cached_availability.0 event=event product=product var=0 %}
                                                {% endif %}
                                                <div class="clearfix"></div>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </fieldset>
                            {% empty %}
                                <em>
                                    {% trans "There are no add-ons available for this product." %}
                                </em>
                            {% endfor %}
                        </div>
                    </div>
                </details>
            {% endfor %}
        </div>
        <div class="row checkout-button-row">
            <div class="col-md-4 col-sm-6">
                <a class="btn btn-block btn-default btn-lg"
                        href="{{ prev_url }}">
                    {% trans "Go back" %}
                </a>
            </div>
            <div class="col-md-4 col-md-offset-4 col-sm-6">
                <button class="btn btn-block btn-primary btn-lg" type="submit">
                    {% trans "Continue" %}
                </button>
            </div>
            <div class="clearfix"></div>
        </div>
    </form>
{% endblock %}
